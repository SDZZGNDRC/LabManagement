<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            table {
                width: 100%;
                border-collapse: collapse;
            }
            
            th, td {
                padding: 8px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }
            
            .reserve-button {
                background-color: rgb(7, 224, 3);
                color: white;
                padding: 8px 16px;
                border: none;
                cursor: pointer;
                width: 150px;
            }
            .reserved-button {
                background-color: rgb(255, 71, 71);
                color: white;
                padding: 8px 16px;
                border: none;
                cursor: pointer;
                width: 150px;
            }
        </style>
        <title>实验教学管理系统 - 预约实验</title>
    </head>
    <body>
        <a class="home-link" href="/home">返回首页</a>
        <h1 style="text-align: center;">预约实验</h1>
    
        <table id="experimentTable">
            <tr>
                <th>实验</th>
                <th>时间</th>
                <th>操作</th>
            </tr>
        </table>

        <script>
            function formatTimestamp(timestamp) {
                var date = new Date(timestamp * 1000); // Multiply by 1000 to convert from seconds to milliseconds
                var formattedDate = date.toLocaleString();
                return formattedDate;
            }

            function reserveExperiment(lab, startTime, endTime) {
                var reserveData = {
                    lab: lab,
                    startTime: startTime,
                    endTime: endTime
                };

                fetch("/lab/reserve", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": localStorage.getItem("token")
                    },
                    body: JSON.stringify(reserveData)
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.status === "success") {
                        alert("实验预约成功！");
                    } else {
                        alert("实验预约失败: " + data.message);
                        console.log(data.message);
                    }
                })
                .catch(function(error) {
                    console.log(error);
                });
            }

            // Fetch experiment data from the /list API endpoint
            fetch("/lab/list", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": localStorage.getItem("token")
                }
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.status === "success") {
                    var labs = data.labs;
    
                    // Create table rows dynamically based on the experiment data
                    var table = document.getElementById("experimentTable");
                    labs.forEach(function(lab) {
                        var row = document.createElement("tr");
    
                        var nameCell = document.createElement("td");
                        nameCell.textContent = lab.name;
                        row.appendChild(nameCell);
    
                        var timeCell = document.createElement("td");
                        timeCell.textContent = formatTimestamp(lab.startTime) + " - " + formatTimestamp(lab.endTime);
                        row.appendChild(timeCell);
    
                        var actionCell = document.createElement("td");
                        var reserveButton = document.createElement("button");
                        reserveButton.className = "reserve-button";
                        reserveButton.id = `reserveButton_${lab.name}_${lab.startTime}_${lab.endTime}`;
                        reserveButton.textContent = "预约";
                        reserveButton.addEventListener("click", function() {
                            reserveExperiment(lab.name, lab.startTime, lab.endTime);
                            reserveButton.disabled = true;
                            reserveButton.className = "reserved-button";
                            reserveButton.textContent = "已预约";
                        });
                        actionCell.appendChild(reserveButton);
                        row.appendChild(actionCell);
    
                        table.appendChild(row);
                    });
                    
                // Fetch experiment data from the /list API endpoint with reserved=true query parameter
                fetch("/lab/list?reserved=true", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": localStorage.getItem("token")
                    }
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.status === "success") {
                        var reservedLabs = data.labs;

                        // Update reserveButton.textContent based on whether the lab is reserved or not
                        labs.forEach(function(lab) {
                            var reserveButton = document.getElementById(`reserveButton_${lab.name}_${lab.startTime}_${lab.endTime}`);
                            if (reservedLabs.some(reservedLab => reservedLab.name === lab.name)) {
                                reserveButton.textContent = "已预约";
                                reserveButton.className = "reserved-button";
                                reserveButton.disabled = true;
                            }
                        });
                    } else {
                        console.log("Failed to fetch reserved labs data.");
                    }
                })
                .catch(function(error) {
                    console.log(error);
                });
                } else {
                    console.log("Failed to fetch experiment data.");
                }   
            })
            .catch(function(error) {
                console.log(error);
            });
        </script>
    </body>
</html>
